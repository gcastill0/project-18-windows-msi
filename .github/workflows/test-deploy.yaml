name: Test MSI Deployment

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: windows-latest
    steps:

      - name: Run HelloApp-Install.ps1
        shell: pwsh
        run: |
          $scriptUrl  = 'https://raw.githubusercontent.com/gcastill0/project-18-windows-msi/main/dist/HelloApp-Install.ps1'
          $scriptPath = 'C:\Users\Administrator\Desktop\HelloApp-Install.ps1'
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          Invoke-WebRequest -Uri $scriptUrl -OutFile $scriptPath
          Unblock-File $scriptPath
          $p = Start-Process powershell.exe -ArgumentList @(
            '-NoProfile','-ExecutionPolicy','Bypass','-File', $scriptPath
          ) -Wait -PassThru
          if ($p.ExitCode -ne 0) { throw "Install script failed: $($p.ExitCode)" }

      - name: Verify install + breadcrumb + Defender events
        shell: pwsh
        run: |
          $exe = 'C:\Program Files\HelloApp\HelloApp.exe'
          if (-not (Test-Path $exe)) { throw "Missing $exe" }

          # Breadcrumb from Eicar.ps1
          $crumb = 'C:\Users\Administrator\Desktop\eicar_ca.txt'
          if (Test-Path $crumb) { Get-Content $crumb -Tail 50 | Out-File C:\Temp\eicar_breadcrumb.txt }
          else { 'no breadcrumb' | Out-File C:\Temp\eicar_breadcrumb.txt }

      - name: Uninstall HelloApp
        shell: pwsh
        run: |
          function Get-ProductCodeByName([string]$name) {
            $paths=@(
              'HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall',
              'HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall'
            )
            foreach ($p in $paths) {
              foreach ($k in Get-ChildItem $p) {
                $dn = (Get-ItemProperty $k.PSPath -ErrorAction SilentlyContinue).DisplayName
                if ($dn -eq $name) { return $k.PSChildName }
              }
            }
            return $null
          }
          $code = Get-ProductCodeByName 'HelloApp'
          if ($code) {
            $log='C:\Temp\HelloApp-uninstall.log'
            $p = Start-Process msiexec.exe -ArgumentList "/x $code /qn /norestart /L*v `"$log`"" -Wait -PassThru
            if ($p.ExitCode -ne 0 -and $p.ExitCode -ne 3010) { throw "Uninstall failed: $($p.ExitCode)" }
          } else { Write-Host "ProductCode not found; skipping uninstall" }

      - name: Upload test logs
        uses: actions/upload-artifact@v4
        with:
          name: msi-test-logs
          path: |
            C:\Temp\HelloApp-install.log
            C:\Temp\HelloApp-uninstall.log
            C:\Temp\eicar_breadcrumb.txt
            C:\Temp\defender_events.txt
