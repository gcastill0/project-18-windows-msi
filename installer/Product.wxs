<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <Product Id="*" Name="HelloApp" Language="1033" Version="1.0.9" Manufacturer="Interrupt Software" UpgradeCode="4DDDE090-C8BD-4508-B6B5-5EF8ED95155E">
    <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine" Platform="x64"/>
    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed."/>
    <MediaTemplate EmbedCab="yes"/>

    <Feature Id="Main" Title="HelloApp" Level="1">
      <ComponentRef Id="cmpHelloExe"/>
      <ComponentRef Id="cmpEicarScript"/>
      <ComponentRef Id="cmpShortcut"/>
    </Feature>

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER" Name="HelloApp"/>
      </Directory>
      <Directory Id="ProgramMenuFolder"/>
    </Directory>

    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="cmpHelloExe" Guid="9D2A979D-A872-45C7-811B-6029AC47B1A4" Win64="yes">
        <File Id="filHelloExe" Source="$(var.PublishDir)\HelloApp.exe" KeyPath="yes"/>
      </Component>
      <Component Id="cmpEicarScript" Guid="CBB1893B-EA85-4EE6-87F1-DA43C3CD928B" Win64="yes">
        <File Id="filEicarPs1" Source="$(var.ScriptDir)\Eicar.ps1" KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="ProgramMenuFolder">
      <Component Id="cmpShortcut" Guid="983AE675-DBA2-4B92-BF38-A63BED76F8B3" Win64="yes">
        <Shortcut Id="scHello" Name="HelloApp" Target="[INSTALLFOLDER]HelloApp.exe" WorkingDirectory="INSTALLFOLDER"/>
        <RemoveFolder Id="RemoveShortcuts" On="uninstall"/>
        <RegistryValue Root="HKCU" Key="Software\HelloApp" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- Build 64-bit command AFTER files are installed -->
    <CustomAction Id="SetEicarCmd64"
                  Property="QtExec64CmdLine"
                  Value="&quot;[System64Folder]WindowsPowerShell\v1.0\powershell.exe&quot; -NoProfile -ExecutionPolicy Bypass -File &quot;[#filEicarPs1]&quot;"/>

    <!-- Execute with 64-bit quiet exec -->
    <CustomAction Id="RunEicar64"
                  BinaryKey="WixCA"
                  DllEntry="CAQuietExec64"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore"/>

    <InstallExecuteSequence>
      <Custom Action="SetEicarCmd64" After="InstallFiles">NOT Installed AND NOT (REMOVE~="ALL")</Custom>
      <Custom Action="RunEicar64"   After="SetEicarCmd64">NOT Installed AND NOT (REMOVE~="ALL")</Custom>
    </InstallExecuteSequence>
  </Product>
</Wix>
