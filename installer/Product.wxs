<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <Product Id="*" Name="HelloApp" Language="1033" Version="1.0.6" Manufacturer="Interrupt Software" UpgradeCode="4DDDE090-C8BD-4508-B6B5-5EF8ED95155E">
    <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine" />
    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
    <MediaTemplate EmbedCab="yes" />
    <Feature Id="Main" Title="HelloApp" Level="1">
      <ComponentRef Id="cmpHelloExe"/>
      <ComponentRef Id="cmpEicarScript"/>
      <ComponentRef Id="cmpShortcut"/>
    </Feature>

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLFOLDER" Name="HelloApp" />
      </Directory>
      <Directory Id="ProgramMenuFolder" />
    </Directory>

    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="cmpHelloExe" Guid="9D2A979D-A872-45C7-811B-6029AC47B1A4">
        <File Id="filHelloExe" Source="$(var.PublishDir)\HelloApp.exe" KeyPath="yes" />
      </Component>
      <Component Id="cmpEicarScript" Guid="CBB1893B-EA85-4EE6-87F1-DA43C3CD928B">
        <File Id="filEicarPs1" Source="$(var.ScriptDir)\Eicar.ps1" KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="ProgramMenuFolder">
      <Component Id="cmpShortcut" Guid="983AE675-DBA2-4B92-BF38-A63BED76F8B3">
        <Shortcut Id="scHello" Name="HelloApp" Target="[INSTALLFOLDER]HelloApp.exe" WorkingDirectory="INSTALLFOLDER"/>
        <RemoveFolder Id="RemoveShortcuts" On="uninstall"/>
        <RegistryValue Root="HKCU" Key="Software\HelloApp" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <CustomAction Id="SetEicarCmd"
              Property="QtExecCmdLine"
              Value="&quot;[System64Folder]WindowsPowerShell\v1.0\powershell.exe&quot; -NoProfile -ExecutionPolicy Bypass -File &quot;[#filEicarPs1]&quot;"/>

    <CustomAction Id="RunEicar"
              BinaryKey="WixCA"
              DllEntry="CAQuietExec"
              Execute="deferred"
              Impersonate="no"
              Return="ignore"/>

    <InstallExecuteSequence>
        <Custom Action="SetEicarCmd" Before="RunEicar">NOT Installed AND NOT (REMOVE~="ALL")</Custom>
        <Custom Action="RunEicar" After="InstallFiles">NOT Installed AND NOT (REMOVE~="ALL")</Custom>
    </InstallExecuteSequence>

  </Product>
</Wix>