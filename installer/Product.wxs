<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <Product Id="*" Name="HelloApp" Language="1033" Version="1.0.10" Manufacturer="Interrupt Software" UpgradeCode="4DDDE090-C8BD-4508-B6B5-5EF8ED95155E">
    <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine" Platform="x64"/>
    <MajorUpgrade DowngradeErrorMessage="A newer version is already installed."/>
    <MediaTemplate EmbedCab="yes"/>

    <Feature Id="Main" Title="HelloApp" Level="1">
      <ComponentRef Id="cmpHelloExe"/>
      <ComponentRef Id="cmpEicarScript"/>
      <ComponentRef Id="cmpShortcut"/>
      <ComponentRef Id="cmpEicarTask"/>   <!-- run PS via scheduled task -->
    </Feature>

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER" Name="HelloApp"/>
      </Directory>
      <Directory Id="ProgramMenuFolder"/>
    </Directory>

    <DirectoryRef Id="INSTALLFOLDER">
      <Component Id="cmpHelloExe" Guid="9D2A979D-A872-45C7-811B-6029AC47B1A4" Win64="yes">
        <File Id="filHelloExe" Source="$(var.PublishDir)\HelloApp.exe" KeyPath="yes"/>
      </Component>

      <Component Id="cmpEicarScript" Guid="CBB1893B-EA85-4EE6-87F1-DA43C3CD928B" Win64="yes">
        <File Id="filEicarPs1" Source="$(var.ScriptDir)\Eicar.ps1" KeyPath="yes"/>
      </Component>

      <!-- One-shot scheduled task to run PS script as SYSTEM, immediately on install -->
      <Component Id="cmpEicarTask" Guid="B0C3F8D0-0A8E-4C1E-9E6C-2C2F5B0B6A11" Win64="yes">
        <util:ScheduledTask
            Id="RunEicarTask"
            Name="HelloApp-Eicar"
            ApplicationName="[System64Folder]WindowsPowerShell\v1.0\powershell.exe"
            Arguments='-NoProfile -ExecutionPolicy Bypass -File "[#filEicarPs1]"'
            StartOnInstall="yes"
            Enabled="yes"
            DeleteWhenNotFound="yes"
            LogonType="ServiceAccount"
            AccountName="SYSTEM"
            RunLevel="Highest"/>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="ProgramMenuFolder">
      <Component Id="cmpShortcut" Guid="983AE675-DBA2-4B92-BF38-A63BED76F8B3" Win64="yes">
        <Shortcut Id="scHello" Name="HelloApp" Target="[INSTALLFOLDER]HelloApp.exe" WorkingDirectory="INSTALLFOLDER"/>
        <RemoveFolder Id="RemoveShortcuts" On="uninstall"/>
        <RegistryValue Root="HKCU" Key="Software\HelloApp" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
      </Component>
    </DirectoryRef>
  </Product>
</Wix>
